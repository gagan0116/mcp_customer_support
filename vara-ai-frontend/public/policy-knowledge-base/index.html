<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARA-AI - Policy Compiler</title>
    <meta name="description" content="Turn PDF Policies into queryable Knowledge Graphs using AI">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Vis.js for Graph Visualization -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <!-- Background Effects -->
    <div class="bg-gradient"></div>
    <div class="bg-grid"></div>
    <div class="floating-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon" style="overflow: hidden;">
                    <img src="favicon.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <div class="logo-text">
                    <span class="logo-title">VARA-AI</span>
                    <span class="logo-subtitle">Policy Compiler Agent</span>
                </div>
            </div>
            <nav class="header-nav">
                <a href="../" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                    </svg>
                    <span>Email Pipeline</span>
                </a>
                <a href="#" class="nav-link active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3" />
                        <circle cx="6" cy="12" r="3" />
                        <circle cx="18" cy="19" r="3" />
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                    </svg>
                    <span>Policy Knowledge Base</span>
                </a>
            </nav>
            <a href="#" class="help-link" id="helpLink">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                    <line x1="12" y1="17" x2="12.01" y2="17" />
                </svg>
                How it works
            </a>
        </div>
    </header>

    <!-- Onboarding Banner -->
    <div class="onboarding-banner" id="onboardingBanner">
        <div class="onboarding-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3" />
                <circle cx="6" cy="12" r="3" />
                <circle cx="18" cy="19" r="3" />
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
            </svg>
        </div>
        <div class="onboarding-content">
            <h3 class="onboarding-title">Policy Knowledge Base</h3>
            <p class="onboarding-text">Transform your PDF policies into a queryable knowledge graph. Upload policy
                documents, and watch as AI parses, extracts entities, and builds a Neo4j graph. Tap the
                <strong>i</strong> icons for explanations of each step.
            </p>
        </div>
        <button class="onboarding-dismiss" id="dismissOnboarding">Got it</button>
    </div>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Left Panel: Controls -->
        <section class="panel">
            <!-- Visualize Knowledge Base Section -->
            <div class="panel-header">
                <div class="panel-icon" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3" />
                        <circle cx="6" cy="12" r="3" />
                        <circle cx="18" cy="19" r="3" />
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                    </svg>
                </div>
                <h2 class="panel-title">Visualize Knowledge Base</h2>
                <button class="info-icon" data-tooltip="visualize" tabindex="0"
                    aria-label="Info about visualize">i</button>
            </div>

            <!-- Visualize Card -->
            <div class="card">
                <p class="card-description">View the current Knowledge Graph without recompiling</p>
                <button id="viz-btn" class="btn btn-success">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <polygon points="10 8 16 12 10 16 10 8" />
                    </svg>
                    Visualize Graph
                </button>
            </div>

            <!-- Policy Upload Section -->
            <div class="panel-header" style="margin-top: var(--spacing-xl);">
                <div class="panel-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                </div>
                <h2 class="panel-title">Policy Upload</h2>
                <button class="info-icon" data-tooltip="upload" tabindex="0" aria-label="Info about upload">i</button>
            </div>

            <!-- Upload Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-number">1</span>
                    <h3 class="card-title">Upload Policy Documents</h3>
                </div>
                <p class="card-description">Upload PDF policy documents to compile into a knowledge graph</p>

                <div class="upload-zone" id="drop-zone">
                    <input type="file" id="file-input" multiple accept=".pdf" class="hidden" style="display: none;">
                    <label for="file-input" style="cursor: pointer; display: block;">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                        </div>
                        <div class="upload-text">
                            <span class="upload-text-highlight">Click to upload</span> or drag and drop
                        </div>
                        <div class="upload-hint">PDF files only</div>
                    </label>
                    <div class="file-list" id="file-list"></div>
                </div>

                <button id="compile-btn" class="btn btn-primary" disabled style="margin-top: 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    Start Compilation
                </button>
            </div>

            <!-- Progress Card -->
            <div class="card progress-section" id="status-card">
                <div class="card-header">
                    <span class="card-number">2</span>
                    <h3 class="card-title">Compilation Progress</h3>
                </div>

                <div class="progress-header">
                    <span class="progress-status" id="status-text">Initializing...</span>
                    <span class="progress-percent" id="progress-percent">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>

                <!-- Pipeline Steps -->
                <div class="pipeline-steps" id="pipeline-steps">
                    <div class="pipeline-step" data-step="parsing">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-name">Document Parsing <button class="info-icon" data-tooltip="kb-parsing"
                                    tabindex="0" aria-label="Info about parsing">i</button></div>
                            <div class="step-description">Extracting text from PDF documents</div>
                        </div>
                        <span class="step-status">Pending</span>
                    </div>
                    <div class="pipeline-step" data-step="ontology">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M12 16v-4M12 8h.01" />
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-name">Ontology Design <button class="info-icon" data-tooltip="ontology"
                                    tabindex="0" aria-label="Info about ontology">i</button></div>
                            <div class="step-description">Designing graph schema with Gemini</div>
                        </div>
                        <span class="step-status">Pending</span>
                    </div>
                    <div class="pipeline-step" data-step="extraction">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="16 18 22 12 16 6" />
                                <polyline points="8 6 2 12 8 18" />
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-name">Entity Extraction <button class="info-icon"
                                    data-tooltip="kb-extraction" tabindex="0"
                                    aria-label="Info about extraction">i</button></div>
                            <div class="step-description">Extracting entities & relationships</div>
                        </div>
                        <span class="step-status">Pending</span>
                    </div>
                    <div class="pipeline-step" data-step="validation">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                <polyline points="22 4 12 14.01 9 11.01" />
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-name">Critic Validation <button class="info-icon" data-tooltip="validation"
                                    tabindex="0" aria-label="Info about validation">i</button></div>
                            <div class="step-description">Validating extraction quality</div>
                        </div>
                        <span class="step-status">Pending</span>
                    </div>
                    <div class="pipeline-step" data-step="building">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <ellipse cx="12" cy="5" rx="9" ry="3" />
                                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-name">Graph Building <button class="info-icon" data-tooltip="building"
                                    tabindex="0" aria-label="Info about graph building">i</button></div>
                            <div class="step-description">Constructing Neo4j knowledge graph</div>
                        </div>
                        <span class="step-status">Pending</span>
                    </div>
                </div>

                <!-- Logs -->
                <div class="logs-container" id="logs" style="margin-top: 16px;">
                    <div class="log-entry">
                        <span class="log-time">--:--:--</span>
                        <span class="log-message">Waiting for compilation to start...</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Right Panel: Graph Visualization -->
        <section class="panel graph-panel">
            <div class="panel-header">
                <div class="panel-icon" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3" />
                        <circle cx="6" cy="12" r="3" />
                        <circle cx="18" cy="19" r="3" />
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                    </svg>
                </div>
                <h2 class="panel-title">Knowledge Graph</h2>
                <div class="graph-stats" id="graph-stats">
                    Nodes: <span id="node-count">0</span> <button class="info-icon" data-tooltip="node-count"
                        tabindex="0" aria-label="Info about nodes" style="margin-right: 8px;">i</button>| Edges: <span
                        id="edge-count">0</span> <button class="info-icon" data-tooltip="edge-count" tabindex="0"
                        aria-label="Info about edges">i</button>
                </div>
            </div>

            <div class="graph-container" id="graph-container">
                <div id="mynetwork"></div>
                <div class="empty-state" id="empty-state">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="18" cy="5" r="3" />
                            <circle cx="6" cy="12" r="3" />
                            <circle cx="18" cy="19" r="3" />
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                        </svg>
                    </div>
                    <h3 class="empty-state-title">No Graph Data</h3>
                    <p class="empty-state-description">Upload a policy document and compile, or click "Visualize Graph"
                        to view existing data</p>
                </div>
            </div>

            <div class="graph-hint">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"
                    style="display: inline; vertical-align: middle; margin-right: 4px;">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 16v-4M12 8h.01" />
                </svg>
                Scroll to zoom ‚Ä¢ Drag to pan ‚Ä¢ Click nodes for details
            </div>
        </section>
    </main>

    <!-- HLD Pipeline Diagram Modal -->
    <div class="hld-modal-overlay hidden" id="hldModal">
        <div class="hld-modal-content">
            <div class="hld-modal-header">
                <div class="hld-modal-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                        <circle cx="18" cy="5" r="3" />
                        <circle cx="6" cy="12" r="3" />
                        <circle cx="18" cy="19" r="3" />
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                    </svg>
                    <h2>How VARA-AI Works</h2>
                </div>
                <p class="hld-modal-subtitle">Click on any step to learn more about the process</p>
                <button class="hld-modal-close" id="hldModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>

            <div class="hld-modal-body">
                <!-- Interactive Pipeline Diagram -->
                <div class="hld-pipeline-container">
                    <!-- Animated Background Lines -->
                    <svg class="hld-flow-lines" viewBox="0 0 1200 400" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <linearGradient id="flowGradient1" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="flowGradient2" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#22c55e;stop-opacity:1" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur" />
                                <feMerge>
                                    <feMergeNode in="coloredBlur" />
                                    <feMergeNode in="SourceGraphic" />
                                </feMerge>
                            </filter>
                        </defs>
                        <!-- Main flow path -->
                        <path class="flow-path flow-path-1" d="M 80 200 Q 150 200 180 200 L 280 200"
                            stroke="url(#flowGradient1)" stroke-width="3" fill="none" filter="url(#glow)" />
                        <path class="flow-path flow-path-2" d="M 320 200 Q 380 200 400 200 L 480 200"
                            stroke="url(#flowGradient1)" stroke-width="3" fill="none" filter="url(#glow)" />
                        <path class="flow-path flow-path-3" d="M 520 200 Q 580 200 600 200 L 680 200"
                            stroke="url(#flowGradient1)" stroke-width="3" fill="none" filter="url(#glow)" />
                        <path class="flow-path flow-path-4" d="M 720 200 Q 780 200 800 200 L 880 200"
                            stroke="url(#flowGradient2)" stroke-width="3" fill="none" filter="url(#glow)" />
                        <path class="flow-path flow-path-5" d="M 920 200 Q 980 200 1000 200 L 1080 200"
                            stroke="url(#flowGradient2)" stroke-width="3" fill="none" filter="url(#glow)" />
                        <!-- Animated particles -->
                        <circle class="flow-particle particle-1" r="5" fill="#6366f1" filter="url(#glow)">
                            <animateMotion dur="3s" repeatCount="indefinite"
                                path="M 80 200 Q 150 200 180 200 L 280 200" />
                        </circle>
                        <circle class="flow-particle particle-2" r="5" fill="#8b5cf6" filter="url(#glow)">
                            <animateMotion dur="3s" repeatCount="indefinite" begin="0.5s"
                                path="M 320 200 Q 380 200 400 200 L 480 200" />
                        </circle>
                        <circle class="flow-particle particle-3" r="5" fill="#06b6d4" filter="url(#glow)">
                            <animateMotion dur="3s" repeatCount="indefinite" begin="1s"
                                path="M 520 200 Q 580 200 600 200 L 680 200" />
                        </circle>
                        <circle class="flow-particle particle-4" r="5" fill="#8b5cf6" filter="url(#glow)">
                            <animateMotion dur="3s" repeatCount="indefinite" begin="1.5s"
                                path="M 720 200 Q 780 200 800 200 L 880 200" />
                        </circle>
                        <circle class="flow-particle particle-5" r="5" fill="#22c55e" filter="url(#glow)">
                            <animateMotion dur="3s" repeatCount="indefinite" begin="2s"
                                path="M 920 200 Q 980 200 1000 200 L 1080 200" />
                        </circle>
                    </svg>

                    <!-- Pipeline Steps -->
                    <div class="hld-steps-row">
                        <!-- Step 1: Customer Email -->
                        <div class="hld-step" data-step="email" tabindex="0">
                            <div class="hld-step-icon email">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                    <polyline points="22,6 12,13 2,6" />
                                </svg>
                            </div>
                            <div class="hld-step-label">Customer Email</div>
                            <div class="hld-step-badge input">INPUT</div>
                            <div class="hld-step-tooltip">
                                <h4>üìß Where It All Starts</h4>
                                <p>A customer sends an email asking for help with a return, refund, or product
                                    replacement. They can attach their receipt or photos of damaged items.</p>
                                <div class="tooltip-details">
                                    <span class="detail-item">üìé Attach receipts & photos</span>
                                    <span class="detail-item">‚úâÔ∏è Just send an email!</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Gmail Monitoring -->
                        <div class="hld-step" data-step="gmail" tabindex="0">
                            <div class="hld-step-icon gmail">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                                </svg>
                            </div>
                            <div class="hld-step-label">Gmail Monitoring</div>
                            <div class="hld-step-badge trigger">TRIGGER</div>
                            <div class="hld-step-tooltip">
                                <h4>üîî Always Watching the Inbox</h4>
                                <p>Our system automatically monitors the support inbox 24/7. The moment a new email
                                    arrives, we spring into action ‚Äî no waiting, no delays!</p>
                                <div class="tooltip-details">
                                    <span class="detail-item">‚ö° Instant detection</span>
                                    <span class="detail-item">üïê Works 24/7</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: AI Classification -->
                        <div class="hld-step" data-step="classify" tabindex="0">
                            <div class="hld-step-icon classify">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 2 7 12 12 22 7 12 2" />
                                    <polyline points="2 17 12 22 22 17" />
                                    <polyline points="2 12 12 17 22 12" />
                                </svg>
                            </div>
                            <div class="hld-step-label">AI Classification</div>
                            <div class="hld-step-badge gemini">GEMINI 3</div>
                            <div class="hld-step-tooltip">
                                <h4>üß† Understanding the Request</h4>
                                <p>Our AI reads the email like a human would and figures out what the customer needs. Is
                                    it a return? A refund? A replacement? The AI understands the intent.</p>
                                <div class="tooltip-details">
                                    <span class="detail-item category-return">üì¶ Return</span>
                                    <span class="detail-item category-refund">üí∞ Refund</span>
                                    <span class="detail-item category-replace">üîÑ Replace</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Document Processing -->
                        <div class="hld-step" data-step="docs" tabindex="0">
                            <div class="hld-step-icon docs">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                    <polyline points="14 2 14 8 20 8" />
                                    <line x1="16" y1="13" x2="8" y2="13" />
                                    <line x1="16" y1="17" x2="8" y2="17" />
                                </svg>
                            </div>
                            <div class="hld-step-label">Document Processing</div>
                            <div class="hld-step-badge mcp">MCP SERVER</div>
                            <div class="hld-step-tooltip">
                                <h4>üìÑ Reading Attachments</h4>
                                <p>The AI opens and reads any attached files ‚Äî like scanning a receipt to find the order
                                    number, date, and items purchased. It can also look at photos to assess product
                                    damage.</p>
                                <div class="tooltip-details">
                                    <span class="detail-item">üßæ Reads PDF receipts</span>
                                    <span class="detail-item">üì∑ Analyzes photos</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Database Verification -->
                        <div class="hld-step" data-step="database" tabindex="0">
                            <div class="hld-step-icon database">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <ellipse cx="12" cy="5" rx="9" ry="3" />
                                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                                </svg>
                            </div>
                            <div class="hld-step-label">Database Verification</div>
                            <div class="hld-step-badge postgres">POSTGRESQL</div>
                            <div class="hld-step-tooltip">
                                <h4>üîç Checking the Records</h4>
                                <p>We verify the customer's information against our order database. Did they really buy
                                    this item? When? How much did they pay? This ensures everything matches up.</p>
                                <div class="tooltip-details">
                                    <span class="detail-item">‚úÖ Confirms purchase</span>
                                    <span class="detail-item">üìã Matches order details</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 6: Policy Engine -->
                        <div class="hld-step" data-step="policy" tabindex="0">
                            <div class="hld-step-icon policy">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="18" cy="5" r="3" />
                                    <circle cx="6" cy="12" r="3" />
                                    <circle cx="18" cy="19" r="3" />
                                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                                </svg>
                            </div>
                            <div class="hld-step-label">Policy Engine</div>
                            <div class="hld-step-badge neo4j">NEO4J</div>
                            <div class="hld-step-tooltip">
                                <h4>üìñ Consulting the Rulebook</h4>
                                <p>Like a smart assistant who memorized the entire return policy! The AI checks all
                                    company rules ‚Äî return windows, eligible items, exceptions ‚Äî to make a fair
                                    decision.</p>
                                <div class="tooltip-details">
                                    <span class="detail-item">üìÖ Return deadlines</span>
                                    <span class="detail-item">üìú Policy rules</span>
                                    <span class="detail-item">‚öñÔ∏è Fair decisions</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 7: Decision -->
                        <div class="hld-step" data-step="decision" tabindex="0">
                            <div class="hld-step-icon decision">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                    <polyline points="22 4 12 14.01 9 11.01" />
                                </svg>
                            </div>
                            <div class="hld-step-label">Decision & Response</div>
                            <div class="hld-step-badge output">OUTPUT</div>
                            <div class="hld-step-tooltip">
                                <h4>‚úÖ The Final Answer</h4>
                                <p>The AI makes a decision and explains it clearly to the customer. Every decision comes
                                    with a reason, so customers understand exactly why their request was approved or
                                    denied.</p>
                                <div class="tooltip-details">
                                    <span class="detail-item decision-approve">‚úì Approved</span>
                                    <span class="detail-item decision-deny">‚úó Denied</span>
                                    <span class="detail-item decision-review">üëÄ Needs Review</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technology Stack Legend -->
                <div class="hld-legend">
                    <h4>Technology Stack</h4>
                    <div class="legend-items">
                        <div class="legend-item">python</div>
                        <div class="legend-item">gemini-3-api</div>
                        <div class="legend-item">fastapi</div>
                        <div class="legend-item">mcp</div>
                        <div class="legend-item">postgresql</div>
                        <div class="legend-item">google-cloud-sql</div>
                        <div class="legend-item">google-cloud</div>
                        <div class="legend-item">cloud-run</div>
                        <div class="legend-item">pubsub</div>
                        <div class="legend-item">cloud-build</div>
                        <div class="legend-item">firestore</div>
                        <div class="legend-item">docker</div>
                        <div class="legend-item">neo4j-aura</div>
                        <div class="legend-item">pypdf</div>
                        <div class="legend-item">oauth</div>
                        <div class="legend-item">sse-starlette</div>
                        <div class="legend-item">llama-parse</div>
                        <div class="legend-item">cloud-tasks</div>
                        <div class="legend-item">gmail-api</div>
                        <div class="legend-item">uvicorn</div>
                        <div class="legend-item">multi-agent-system</div>
                        <div class="legend-item">beautiful-soup</div>
                        <div class="legend-item">javascript</div>
                        <div class="legend-item">google-genai</div>
                        <div class="legend-item">asyncio</div>
                        <div class="legend-item">fastmcp</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL - Cloud Run service
        const API_BASE = 'https://policy-compiler-171083103370.northamerica-northeast1.run.app';

        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const dropZone = document.getElementById('drop-zone');
        const compileBtn = document.getElementById('compile-btn');
        const statusCard = document.getElementById('status-card');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const statusText = document.getElementById('status-text');
        const logsDiv = document.getElementById('logs');
        const vizBtn = document.getElementById('viz-btn');
        const nodeCount = document.getElementById('node-count');
        const edgeCount = document.getElementById('edge-count');
        const emptyState = document.getElementById('empty-state');
        const pipelineSteps = document.querySelectorAll('.pipeline-step');

        let currentJobId = null;
        let pollInterval = null;

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                updateFileList(files);
            }
        });

        // File Selection
        fileInput.addEventListener('change', (e) => {
            updateFileList(e.target.files);
        });

        function updateFileList(files) {
            const fileArray = Array.from(files);
            if (fileArray.length === 0) {
                fileList.innerHTML = '';
                compileBtn.disabled = true;
                return;
            }

            fileList.innerHTML = fileArray.map(f => `
                <div class="file-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                    </svg>
                    ${f.name}
                </div>
            `).join('');
            compileBtn.disabled = false;
        }

        // Compile Button
        compileBtn.addEventListener('click', async () => {
            const files = fileInput.files;
            if (files.length === 0) return;

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            // UI Reset
            compileBtn.disabled = true;
            statusCard.classList.add('visible');
            resetPipelineSteps();
            addLog('Starting upload...', 'info');
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            statusText.textContent = 'Uploading...';
            statusText.className = 'progress-status';

            try {
                const response = await fetch(`${API_BASE}/api/compile`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                const data = await response.json();
                currentJobId = data.job_id;
                addLog(`Job started: ${currentJobId}`, 'info');
                startPolling();

            } catch (err) {
                addLog('Error: ' + err.message, 'error');
                compileBtn.disabled = false;
            }
        });

        // Visualize Button
        vizBtn.addEventListener('click', () => {
            loadGraph();
        });

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(checkStatus, 2000);
        }

        async function checkStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`${API_BASE}/api/status/${currentJobId}`);
                const data = await response.json();

                // Update Progress
                const percent = data.progress || 0;
                progressBar.style.width = `${percent}%`;
                progressPercent.textContent = `${percent}%`;
                statusText.textContent = data.status.replace(/_/g, ' ').toUpperCase();

                // Update pipeline steps based on progress
                updatePipelineSteps(data.status, percent);

                // Update Logs
                if (data.logs && data.logs.length > 0) {
                    logsDiv.innerHTML = '';
                    data.logs.forEach(log => addLog(log, 'info'));
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                }

                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    statusText.textContent = '‚úì COMPLETED';
                    statusText.classList.add('completed');
                    addLog('Pipeline completed successfully!', 'info');
                    loadGraph();
                    compileBtn.disabled = false;

                    // Mark all steps as completed
                    pipelineSteps.forEach(step => {
                        step.classList.remove('active');
                        step.classList.add('completed');
                        step.querySelector('.step-status').textContent = 'Completed';
                    });
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    statusText.textContent = '‚úó FAILED';
                    statusText.classList.add('failed');
                    addLog('Pipeline failed: ' + (data.error || 'Unknown error'), 'error');
                    compileBtn.disabled = false;
                }

            } catch (err) {
                console.error("Polling error", err);
            }
        }

        function updatePipelineSteps(status, percent) {
            // Reset all steps
            pipelineSteps.forEach(step => {
                step.classList.remove('active', 'completed');
                step.querySelector('.step-status').textContent = 'Pending';
            });

            // Determine current step based on progress
            const steps = ['parsing', 'ontology', 'extraction', 'validation', 'building'];
            const stepIndex = Math.min(Math.floor(percent / 20), 4);

            steps.forEach((stepName, index) => {
                const step = document.querySelector(`[data-step="${stepName}"]`);
                if (index < stepIndex) {
                    step.classList.add('completed');
                    step.querySelector('.step-status').textContent = 'Completed';
                } else if (index === stepIndex && percent < 100) {
                    step.classList.add('active');
                    step.querySelector('.step-status').textContent = 'Processing...';
                }
            });
        }

        function resetPipelineSteps() {
            pipelineSteps.forEach(step => {
                step.classList.remove('active', 'completed');
                step.querySelector('.step-status').textContent = 'Pending';
            });
        }

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-message ${type}">${message}</span>
            `;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        async function loadGraph() {
            try {
                emptyState.style.display = 'none';
                addLog('Loading graph data...', 'info');

                const response = await fetch(`${API_BASE}/api/graph`);
                const data = await response.json();

                if (data.nodes && data.nodes.length > 0) {
                    renderGraph(data);
                    addLog(`Graph loaded: ${data.nodes.length} nodes, ${data.edges.length} edges`, 'info');
                } else {
                    emptyState.style.display = 'flex';
                    addLog('No graph data available', 'warning');
                }
            } catch (err) {
                console.error("Graph fetch error", err);
                addLog('Failed to load graph: ' + err.message, 'error');
                emptyState.style.display = 'flex';
            }
        }

        function renderGraph(data) {
            const container = document.getElementById('mynetwork');
            emptyState.style.display = 'none';

            // Update stats
            nodeCount.textContent = data.nodes.length;
            edgeCount.textContent = data.edges.length;

            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: {
                        size: 14,
                        color: '#ffffff',
                        face: 'Inter'
                    },
                    borderWidth: 2,
                    color: {
                        background: '#6366f1',
                        border: '#8b5cf6',
                        highlight: {
                            background: '#8b5cf6',
                            border: '#a78bfa'
                        }
                    }
                },
                edges: {
                    width: 2,
                    smooth: {
                        type: 'continuous',
                        roundness: 0.5
                    },
                    color: {
                        color: 'rgba(99, 102, 241, 0.4)',
                        highlight: 'rgba(139, 92, 246, 0.8)'
                    },
                    font: {
                        size: 11,
                        color: '#a0a0b0',
                        face: 'Inter'
                    }
                },
                physics: {
                    stabilization: { iterations: 100 },
                    barnesHut: {
                        gravitationalConstant: -5000,
                        springConstant: 0.02,
                        springLength: 150
                    }
                },
                interaction: {
                    tooltipDelay: 200,
                    hideEdgesOnDrag: true,
                    hover: true
                },
                layout: {
                    improvedLayout: true
                }
            };

            // Color nodes by type if label contains type info
            const coloredNodes = data.nodes.map(node => {
                const colors = {
                    'Policy': '#6366f1',
                    'Rule': '#22c55e',
                    'Category': '#f59e0b',
                    'Condition': '#3b82f6',
                    'Exception': '#ef4444'
                };

                let nodeColor = '#6366f1';
                for (const [type, color] of Object.entries(colors)) {
                    if (node.label && node.label.includes(type)) {
                        nodeColor = color;
                        break;
                    }
                }

                return {
                    ...node,
                    color: {
                        background: nodeColor,
                        border: nodeColor,
                        highlight: {
                            background: nodeColor,
                            border: '#ffffff'
                        }
                    }
                };
            });

            const network = new vis.Network(container, { nodes: coloredNodes, edges: data.edges }, options);

            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = data.nodes.find(n => n.id === nodeId);
                    console.log("Clicked node:", node);
                }
            });
        }

        // Initialize - hide empty state initially
        document.addEventListener('DOMContentLoaded', () => {
            emptyState.style.display = 'flex';
        });

        // ============================================
        // Tooltip System - Tap to Reveal
        // ============================================
        const TooltipManager = {
            overlay: null,
            bubble: null,
            activeIcon: null,

            tooltips: {
                'visualize': {
                    title: 'Visualize Knowledge Base',
                    text: 'Load and display the current knowledge graph without recompiling. Shows the existing graph from Neo4j.'
                },
                'upload': {
                    title: 'Policy Upload',
                    text: 'Upload PDF policy documents to be processed and compiled into a queryable knowledge graph.'
                },
                'kb-parsing': {
                    title: 'Document Parsing',
                    text: 'Converts uploaded PDF policy documents into machine-readable text using LlamaParse for accurate extraction.'
                },
                'ontology': {
                    title: 'Ontology Design',
                    text: 'AI designs the knowledge graph schema, defining entity types (e.g., Policy, Condition, Action) and their relationships.'
                },
                'kb-extraction': {
                    title: 'Entity Extraction',
                    text: 'Extracts specific policy rules, conditions, thresholds, and relationships from the parsed text using LLM.'
                },
                'validation': {
                    title: 'Critic Validation',
                    text: 'Quality check phase where AI reviews extracted entities for accuracy, completeness, and consistency before building the graph.'
                },
                'building': {
                    title: 'Graph Building',
                    text: 'Constructs the Neo4j knowledge graph by creating nodes and edges from validated entities and relationships.'
                },
                'node-count': {
                    title: 'Node Count',
                    text: 'Total number of entities in the graph (policies, rules, conditions, categories, exceptions, etc.).'
                },
                'edge-count': {
                    title: 'Edge Count',
                    text: 'Total number of relationships connecting entities, defining how policies relate to conditions and actions.'
                }
            },

            init() {
                this.overlay = document.createElement('div');
                this.overlay.className = 'tooltip-overlay hidden';
                document.body.appendChild(this.overlay);

                this.bubble = document.createElement('div');
                this.bubble.className = 'tooltip-bubble';
                document.body.appendChild(this.bubble);

                this.overlay.addEventListener('click', () => this.hide());
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.hide();
                });

                document.querySelectorAll('.info-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => this.toggle(e, icon));
                    icon.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.toggle(e, icon);
                        }
                    });
                });
            },

            toggle(event, icon) {
                event.stopPropagation();
                if (this.activeIcon === icon) {
                    this.hide();
                } else {
                    this.show(icon);
                }
            },

            show(icon) {
                const tooltipId = icon.getAttribute('data-tooltip');
                const content = this.tooltips[tooltipId];
                if (!content) return;

                if (this.activeIcon) {
                    this.activeIcon.classList.remove('active');
                }

                this.bubble.innerHTML = `
                    <div class="tooltip-title">${content.title}</div>
                    <div class="tooltip-text">${content.text}</div>
                `;

                const rect = icon.getBoundingClientRect();
                const bubbleWidth = 320;
                const bubbleHeight = this.bubble.offsetHeight || 100;
                const padding = 12;

                let left = rect.left;
                let top = rect.bottom + padding;

                if (left + bubbleWidth > window.innerWidth - padding) {
                    left = window.innerWidth - bubbleWidth - padding;
                    this.bubble.classList.add('arrow-right');
                } else {
                    this.bubble.classList.remove('arrow-right');
                }

                if (top + bubbleHeight > window.innerHeight - padding) {
                    top = rect.top - bubbleHeight - padding;
                    this.bubble.classList.add('arrow-bottom');
                } else {
                    this.bubble.classList.remove('arrow-bottom');
                }

                this.bubble.style.left = `${Math.max(padding, left)}px`;
                this.bubble.style.top = `${Math.max(padding, top)}px`;

                this.overlay.classList.remove('hidden');
                this.bubble.classList.add('visible');
                icon.classList.add('active');
                this.activeIcon = icon;
            },

            hide() {
                this.overlay.classList.add('hidden');
                this.bubble.classList.remove('visible');
                if (this.activeIcon) {
                    this.activeIcon.classList.remove('active');
                    this.activeIcon = null;
                }
            }
        };

        // ============================================
        // Onboarding Banner
        // ============================================
        function initOnboarding() {
            const banner = document.getElementById('onboardingBanner');
            const dismissBtn = document.getElementById('dismissOnboarding');
            const helpLink = document.getElementById('helpLink');

            if (!banner) return;

            const dismissed = localStorage.getItem('varaPolicyOnboardingDismissed');
            if (dismissed) {
                banner.classList.add('hidden');
            }

            if (dismissBtn) {
                dismissBtn.addEventListener('click', () => {
                    banner.classList.add('hidden');
                    localStorage.setItem('varaPolicyOnboardingDismissed', 'true');
                });
            }

            if (helpLink) {
                helpLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    banner.classList.remove('hidden');
                    banner.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            TooltipManager.init();
            initOnboarding();
        });
        // HLD Modal Logic
        const hldModal = document.getElementById('hldModal');
        const helpLink = document.getElementById('helpLink');
        const hldModalClose = document.getElementById('hldModalClose');

        function openHLDModal(e) {
            if (e) e.preventDefault();
            if (hldModal) {
                hldModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                const firstStep = hldModal.querySelector('.hld-step');
                if (firstStep) setTimeout(() => firstStep.focus(), 300);
            }
        }

        function closeHLDModal() {
            if (hldModal) {
                hldModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        if (helpLink) helpLink.addEventListener('click', openHLDModal);
        if (hldModalClose) hldModalClose.addEventListener('click', closeHLDModal);

        if (hldModal) {
            hldModal.addEventListener('click', (e) => {
                if (e.target === hldModal) closeHLDModal();
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && hldModal && !hldModal.classList.contains('hidden')) {
                closeHLDModal();
            }
        });

        // Step Tooltip Interaction
        const stepElements = document.querySelectorAll('.hld-step');
        stepElements.forEach((step, index) => {
            step.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowRight' && index < stepElements.length - 1) {
                    stepElements[index + 1].focus();
                } else if (e.key === 'ArrowLeft' && index > 0) {
                    stepElements[index - 1].focus();
                }
            });
            // Auto-blur others on hover
            step.addEventListener('mouseenter', () => {
                stepElements.forEach(s => {
                    if (s !== step) s.blur();
                });
                step.focus();
            });
        });
    </script>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <span class="copyright">¬© 2026 VARA-AI. </span>
            <span class="footer-divider">|</span>
            <span class="footer-tagline">Powered by Gemini & Neo4j</span>
        </div>
    </footer>
</body>

</html>